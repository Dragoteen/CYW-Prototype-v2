<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner QR Code</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { margin-top: 10px; border: 1px solid #ccc; max-width: 100%; display: none; }
    #message { margin-top: 10px; font-weight: bold; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }

    #card {
      display: none;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      text-align: left;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    .label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    #card img {
      max-width: 120px;
      margin: 10px 5px;
    }

    /* Couleurs par type */
    .normal     { background-color: #888; }
    .z          { background-color: #2e8b57; } /* Vert */
    .classique  { background-color: #b22222; } /* Rouge fonc√© */
    .u          { background-color: #2e8b57; }
    .m√©rican    { background-color: #cc3333; } /* Rouge vif doux */
    .blaster    { background-color: #222; }
    .tr√©sor     { background-color: #a0522d; } /* Marron clair */
    .r√™ve {
      background: radial-gradient(circle at top left, #fceabb, #f8b500);
      border: 4px double #fff700;
      color: #000;
      font-family: 'Georgia', serif;
    }
  </style>
</head>
<body>

  <h1>Scanner un QR Code</h1>

  <button onclick="document.getElementById('file-camera').click()">üì∑ Prendre une photo</button>
  <button onclick="document.getElementById('file-gallery').click()">üñºÔ∏è Choisir une photo</button>

  <input type="file" accept="image/*" capture="environment" id="file-camera" style="display:none" />
  <input type="file" accept="image/*" id="file-gallery" style="display:none" />

  <canvas id="canvas"></canvas>
  <div id="message">Aucune analyse en cours.</div>
  <div id="code_unique_texte"></div>

  <div id="card"></div>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
  <script>
    const fileInputs = [document.getElementById("file-camera"), document.getElementById("file-gallery")];
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const message = document.getElementById("message");
    const codeUniqueTexte = document.getElementById("code_unique_texte");
    const card = document.getElementById("card");

    const typeToClass = {
      "Normal": "normal",
      "Z": "z",
      "Classique": "classique",
      "U": "u",
      "M√©rican": "m√©rican",
      "Blaster": "blaster",
      "R√™ve": "r√™ve",
      "Tr√©sor": "tr√©sor"
    };

    fileInputs.forEach(input => {
      input.addEventListener("change", event => {
        const file = event.target.files[0];
        if (!file) return;

        message.textContent = "Chargement de l'image...";
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.style.display = "block";
          message.textContent = "Analyse en cours...";
          card.style.display = "none";
          codeUniqueTexte.textContent = "";

          try {
            const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
            const binarizer = new ZXing.GlobalHistogramBinarizer(luminanceSource);
            const binaryBitmap = new ZXing.BinaryBitmap(binarizer);
            const reader = new ZXing.MultiFormatReader();
            const result = reader.decode(binaryBitmap);
            const code = result.getText();
            const code_unique = code.replace(/http:\/\/yw\.b-boys\.jp\//i, "");

            message.textContent = "‚úÖ QR Code d√©tect√© : " + code;
            codeUniqueTexte.textContent = "Code Unique : " + code_unique;
            message.textContent = "Chargement des donn√©es...";
            card.style.display = "none";

            const proxy = "https://cors-anywhere.herokuapp.com/";
            const apiUrl = "https://api.sheety.co/d7cbcb1c41ac163fbaff577fe727b2bd/collectionYoKaiWatchJp/medaillons";

            fetch(proxy + apiUrl)
              .then(res => res.json())
              .then(data => {
                const medaillon = data.medaillons.find(m => m.codeUnique === code_unique);
                if (medaillon) {
                  const classeType = typeToClass[medaillon.typeMedaillon] || "normal";
                  const nourritureFormat√©e = (medaillon.nourriturePr√©f√©r√©eYokai || "").replace(/(YW\d[^:]*:)/g, "<br>$1");

                  card.className = "";
                  card.classList.add(classeType);

                  card.innerHTML = `
                    <span class="label">Nom :</span> ${medaillon.nomYokai}<br>
                    <span class="label">Tribu :</span> ${medaillon.tribuYokai}<br>
                    <span class="label">Rang :</span> ${medaillon.rangYokai}<br>
                    <span class="label">Type :</span> ${medaillon.typeMedaillon || "Non d√©fini"}<br>
                    <span class="label">R√¥le :</span> ${medaillon.r√¥leYokai}<br>
                    <span class="label">√âl√©ment :</span> ${medaillon.√©l√©mentYokai}<br>
                    <span class="label">Premi√®re apparition :</span> ${medaillon.premi√®reApparitionYokai}<br>
                    <span class="label">Nourriture pr√©f√©r√©e :</span> ${nourritureFormat√©e}<br>
                    <div style="margin-top:10px;">
                      <img src="${medaillon.imageMedaillon}" alt="M√©daillon">
                      <img src="${medaillon.imageYokai}" alt="Yo-kai">
                    </div>
                  `;
                  card.style.display = "block";
                  message.textContent = "‚úÖ M√©daillon trouv√© !";
                } else {
                  card.innerHTML = "‚ùå M√©daillon non trouv√© dans la base de donn√©es.";
                  card.style.display = "block";
                  message.textContent = "";
                }
              })
              .catch(err => {
                console.error(err);
                card.innerHTML = "‚ùå Erreur de connexion √† la base de donn√©es.";
                card.style.display = "block";
                message.textContent = "";
              });

          } catch (e) {
            message.textContent = "‚ùå Aucun QR code d√©tect√©.";
            codeUniqueTexte.textContent = "";
          }
        };

        img.onerror = () => {
          message.textContent = "‚ùå Erreur de chargement de l'image.";
          codeUniqueTexte.textContent = "";
        };
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);
      });
    });
  </script>
</body>
</html>
