<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner Médaillon Yo-kai Watch</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; color: #222; }
  button { margin: 10px 5px; padding: 10px 15px; font-size: 1rem; }
  #result { margin-top: 20px; padding: 10px; background: white; border-radius: 5px; min-height: 120px; }
  #log { margin-top: 20px; background: black; color: #0f0; font-family: monospace; font-size: 0.9rem; height: 200px; overflow-y: auto; padding: 10px; border-radius: 5px; }
  img { max-width: 100px; margin-right: 10px; vertical-align: middle; }
</style>
</head>
<body>

<h1>Scanner Médaillon Yo-kai Watch</h1>

<button id="takePhotoBtn">Prendre une photo</button>
<button id="choosePhotoBtn">Choisir une photo dans la galerie</button>

<input type="file" accept="image/*" capture="environment" id="takePhotoInput" style="display:none" />
<input type="file" accept="image/*" id="choosePhotoInput" style="display:none" />

<div id="result">En attente d'une photo ou sélection de la galerie...</div>
<div id="log"></div>

<script>
  const takePhotoBtn = document.getElementById('takePhotoBtn');
  const choosePhotoBtn = document.getElementById('choosePhotoBtn');
  const takePhotoInput = document.getElementById('takePhotoInput');
  const choosePhotoInput = document.getElementById('choosePhotoInput');
  const resultDiv = document.getElementById('result');
  const logDiv = document.getElementById('log');

  let html5QrCode = new Html5Qrcode();

  // Fonction pour écrire dans le journal visible
  function appendLog(msg) {
    const time = new Date().toLocaleTimeString();
    logDiv.innerHTML += `[${time}] ${msg}<br>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // Fonction pour afficher un message résultat propre
  function showResult(html, isError = false) {
    resultDiv.innerHTML = `<div style="color: ${isError ? 'red' : 'green'}">${html}</div>`;
  }

  takePhotoBtn.addEventListener('click', () => {
    appendLog("Ouverture de l'appareil photo...");
    takePhotoInput.value = null;
    takePhotoInput.click();
  });

  choosePhotoBtn.addEventListener('click', () => {
    appendLog("Ouverture de la galerie...");
    choosePhotoInput.value = null;
    choosePhotoInput.click();
  });

  takePhotoInput.addEventListener('change', async (e) => {
    if (e.target.files.length === 0) {
      appendLog("Aucune photo prise.");
      showResult("Aucune photo prise.", true);
      return;
    }
    const file = e.target.files[0];
    appendLog(`Photo prise : ${file.name}`);
    await scanFile(file);
  });

  choosePhotoInput.addEventListener('change', async (e) => {
    if (e.target.files.length === 0) {
      appendLog("Aucune photo sélectionnée.");
      showResult("Aucune photo sélectionnée.", true);
      return;
    }
    const file = e.target.files[0];
    appendLog(`Photo choisie : ${file.name}`);
    await scanFile(file);
  });

  async function scanFile(file) {
    showResult("Analyse de l'image en cours...");
    try {
      const qrCodeMessage = await html5QrCode.scanFile(file, true);
      appendLog(`QR Code détecté : ${qrCodeMessage}`);

      const codeUnique = extractCodeUnique(qrCodeMessage);
      appendLog(`Code unique extrait : ${codeUnique}`);

      if (!codeUnique) {
        showResult("❌ QR code détecté mais code unique non extrait.", true);
        return;
      }

      const medaillon = await getMedallionByCode(codeUnique);

      if (!medaillon) {
        showResult("❌ Médaillon inconnu pour ce code unique.", true);
        return;
      }

      displayMedallion(medaillon);

    } catch (err) {
      appendLog("❌ Aucun QR code détecté dans l'image.");
      showResult("❌ Aucun QR code détecté dans l'image.", true);
    }
  }

  function extractCodeUnique(qrCodeMessage) {
    if (!qrCodeMessage) return null;
    const parts = qrCodeMessage.trim().split('/');
    return parts[parts.length - 1];
  }

  async function getMedallionByCode(code) {
    try {
      const response = await fetch("https://api.sheety.co/d7cbcb1c41ac163fbaff577fe727b2bd/collectionYoKaiWatch%20%5Bjp%5DM%C3%A9daillons/medaillons");
      const data = await response.json();
      const medaillons = data.medaillons;
      return medaillons.find(m => m.code_unique === code);
    } catch (error) {
      appendLog(`Erreur API: ${error.message}`);
      showResult("Erreur lors de la récupération des données.", true);
      return null;
    }
  }

  function displayMedallion(medaillon) {
    const html = `
      <h2>Infos Médaillon</h2>
      <p><strong>Code unique :</strong> ${medaillon.code_unique}</p>
      <p><strong>Type :</strong> ${medaillon.type_medaillon}</p>
      <p><strong>Yokai :</strong> ${medaillon.nom_yokai}</p>
      <p><strong>Tribu :</strong> ${medaillon.tribu_yokai}</p>
      <p><strong>Rang :</strong> ${medaillon.rang_yokai}</p>
      <p><strong>Élément :</strong> ${medaillon.élément_yokai}</p>
      <p><strong>Rôle :</strong> ${medaillon.rôle_yokai}</p>
      <p><strong>Première apparition :</strong> ${medaillon.première_apparition_yokai}</p>
      <p><strong>Nourriture préférée :</strong> ${medaillon.nourriture_préférée_yokai}</p>
      <img src="${medaillon.image_medaillon}" alt="Image Médaillon" />
      <img src="${medaillon.image_yokai}" alt="Image Yokai" />
    `;
    showResult(html);
    appendLog("Affichage des infos médaillon terminé.");
  }
</script>

</body>
</html>
