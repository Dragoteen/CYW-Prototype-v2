<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner QR Code - M√©daillons</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; }
  canvas { margin-top: 10px; border: 1px solid #ccc; max-width: 100%; display: none; }
  #message { margin-top: 10px; font-weight: bold; }
  button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
  #card {
    display: none;
    margin: 20px auto;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    text-align: left;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    color: black;
    white-space: pre-line; /* pour interpr√©ter \n dans texte */
  }
  #card img {
    max-width: 100px;
    margin: 10px 5px;
    vertical-align: middle;
  }
  .label {
    font-weight: bold;
    color: #333;
  }
</style>
</head>
<body>

<h1>Scanner un QR Code</h1>

<button onclick="document.getElementById('file-camera').click()">üì∑ Prendre une photo</button>
<button onclick="document.getElementById('file-gallery').click()">üñºÔ∏è Choisir une photo</button>

<input type="file" accept="image/*" capture="environment" id="file-camera" style="display:none" />
<input type="file" accept="image/*" id="file-gallery" style="display:none" />

<canvas id="canvas"></canvas>
<div id="message">Aucune analyse en cours.</div>
<div id="code_unique_texte"></div>
<div id="card"></div>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
  const fileInputs = [document.getElementById("file-camera"), document.getElementById("file-gallery")];
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const message = document.getElementById("message");
  const codeUniqueTexte = document.getElementById("code_unique_texte");
  const card = document.getElementById("card");

  const apiUrl = "https://api.sheety.co/d7cbcb1c41ac163fbaff577fe727b2bd/collectionYoKaiWatchJp/medaillons";

  // Couleurs selon le typeM√©daillon (ordre : Normal, Z, Classique, U, M√©rican, Blaster, R√™ve, Tr√©sor)
  const typeColors = {
    "Normal": "#808080",          // gris
    "Z": "#008000",               // vert
    "Classique": "#8B0000",       // rouge fonc√©
    "U": "#008000",               // m√™me vert que Z
    "M√©rican": "#FF4500",         // rouge un peu p√©tant
    "Blaster": "#000000",         // noir
    "R√™ve": "radial-gradient(circle, #fff 30%, #000 80%)", // effet jeton casino (sera en JS g√©r√© diff√©remment)
    "Tr√©sor": "#A0522D"           // marron clair
  };

  function getCardBackground(type) {
    if (type === "R√™ve") {
      // On simule un jeton casino en CSS inline via un background-image (radial gradient)
      return "radial-gradient(circle, #fff 30%, #000 80%)";
    }
    return typeColors[type] || "#f9f9f9"; // fallback
  }

  fileInputs.forEach(input => {
    input.addEventListener("change", event => {
      const file = event.target.files[0];
      if (!file) return;

      message.textContent = "Chargement de l'image...";
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.style.display = "block";
        message.textContent = "Analyse en cours...";
        card.style.display = "none"; 
        codeUniqueTexte.textContent = "";

        try {
          const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
          const binarizer = new ZXing.GlobalHistogramBinarizer(luminanceSource);
          const binaryBitmap = new ZXing.BinaryBitmap(binarizer);
          const reader = new ZXing.MultiFormatReader();
          const result = reader.decode(binaryBitmap);
          const code = result.getText();
          const code_unique = code.replace(/http:\/\/yw\.b-boys\.jp\//i, "");

          message.textContent = "‚úÖ QR Code d√©tect√© : " + code;
          codeUniqueTexte.textContent = "Code Unique : " + code_unique;

          message.textContent = "Chargement des donn√©es...";
          card.style.display = "none";

          fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
              console.log("Donn√©es compl√®tes re√ßues :", data);
              const medaillon = data.medaillons.find(m => m.codeUnique === code_unique);

              if (!medaillon) {
                card.innerHTML = "‚ùå M√©daillon non trouv√© dans la base de donn√©es.";
                card.style.display = "block";
                message.textContent = "";
                return;
              }

              console.log("Medaillon trouv√© :", medaillon);

              // Pr√©paration du texte avec saut de ligne entre champs
              // Pour nourriture, on remplace " YW2+ :" par \nYW2+ : pour avoir retour √† la ligne
              let nourritureFormattee = medaillon.nourriturePr√©f√©r√©eYokai.replace(/ YW2\+ :/g, '\nYW2+ :');

              // Contenu HTML (textuel + images)
              const html = `
<span class="label">Nom :</span> ${medaillon.nomYokai}\n
<span class="label">Tribu :</span> ${medaillon.tribuYokai}\n
<span class="label">Rang :</span> ${medaillon.rangYokai}\n
<span class="label">Type :</span> ${medaillon.typeM√©daillon}\n
<span class="label">R√¥le :</span> ${medaillon.r√¥leYokai}\n
<span class="label">√âl√©ment :</span> ${medaillon.√©l√©mentYokai}\n
<span class="label">Premi√®re apparition :</span> ${medaillon.premi√®reApparitionYokai}\n
<span class="label">Nourriture pr√©f√©r√©e :</span>\n${nourritureFormattee}\n
\n
<img src="${medaillon.imageM√©daillon}" alt="Image M√©daillon" /> 
<img src="${medaillon.imageYokai}" alt="Image Yokai" />
              `;

              // Comme on veut que \n soit interpr√©t√©, on remplace \n par <br> en innerHTML
              card.innerHTML = html.replace(/\n/g, "<br>");

              // Background selon type
              if (medaillon.typeM√©daillon === "R√™ve") {
                card.style.background = getCardBackground("R√™ve");
                card.style.color = "white";
                card.style.border = "2px solid white";
              } else {
                card.style.background = getCardBackground(medaillon.typeM√©daillon);
                card.style.color = medaillon.typeM√©daillon === "Blaster" ? "white" : "black";
                card.style.border = "2px solid #444";
              }

              card.style.display = "block";
              message.textContent = "‚úÖ M√©daillon trouv√© et affich√©.";
            })
            .catch(err => {
              console.error(err);
              card.innerHTML = "‚ùå Erreur de connexion √† la base de donn√©es.";
              card.style.display = "block";
              message.textContent = "";
            });

        } catch (e) {
          message.textContent = "‚ùå Aucun QR code d√©tect√©.";
          codeUniqueTexte.textContent = "";
        }
      };

      img.onerror = () => {
        message.textContent = "‚ùå Erreur de chargement de l'image.";
        codeUniqueTexte.textContent = "";
      };

      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      reader.readAsDataURL(file);
    });
  });
</script>

</body>
</html>
